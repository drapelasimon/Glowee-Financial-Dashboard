<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Glowee Financial Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Archivo+Narrow:wght@400;500;600;700&family=Archivo:wght@100;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Archivo', Arial, sans-serif;
            background: #ffffff;
            color: #222222;
            min-height: 100vh;
            padding: 0;
        }

        /* Login Screen */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #ff47cc 0%, #ff6bd6 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .login-screen.hidden {
            display: none;
        }

        .login-container {
            background: #ffffff;
            border-radius: 20px;
            padding: 50px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 90%;
        }

        .login-logo {
            width: 120px;
            height: auto;
            margin-bottom: 30px;
        }

        .login-title {
            font-family: 'Archivo Narrow', sans-serif;
            font-size: 28px;
            font-weight: 700;
            color: #222222;
            margin-bottom: 10px;
        }

        .login-subtitle {
            color: #999999;
            font-size: 14px;
            margin-bottom: 30px;
        }

        .login-input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 20px;
            transition: border-color 0.3s;
        }

        .login-input:focus {
            outline: none;
            border-color: #ff47cc;
            box-shadow: 0 0 0 3px rgba(255, 71, 204, 0.1);
        }

        .login-button {
            width: 100%;
            padding: 14px;
            background: #ff47cc;
            color: #ffffff;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .login-button:hover {
            background: #ff6bd6;
        }

        .login-error {
            color: #dc2626;
            font-size: 14px;
            margin-top: 10px;
            display: none;
        }

        /* Main Container */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f2f2f2;
        }

        .header-logo img {
            height: 50px;
            width: auto;
        }

        .header-title {
            flex: 1;
            margin-left: 30px;
        }

        .header-title h1 {
            font-family: 'Archivo Narrow', sans-serif;
            font-size: 32px;
            font-weight: 700;
            color: #222222;
            margin-bottom: 5px;
        }

        .header-date {
            color: #999999;
            font-size: 14px;
        }

        /* Top Metrics Row */
        .metrics-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .metric-card {
            background: #ffffff;
            border: 2px solid #f2f2f2;
            border-radius: 16px;
            padding: 25px;
            display: flex;
            gap: 20px;
            align-items: flex-start;
            transition: all 0.3s;
        }

        .metric-card:hover {
            border-color: #ff47cc;
            box-shadow: 0 4px 12px rgba(255, 71, 204, 0.1);
        }

        .metric-circle {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            color: #ffffff;
            font-weight: bold;
            font-size: 28px;
        }

        .metric-circle.blue {
            background: #4A90E2;
        }

        .metric-circle.orange {
            background: #F5A623;
        }

        .metric-circle.green {
            background: #4ade80;
        }

        .metric-circle.pink {
            background: #ff47cc;
        }

        .metric-info {
            flex: 1;
        }

        .metric-label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #999999;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .metric-change {
            font-size: 14px;
            margin-bottom: 5px;
            display: block;
        }

        .metric-change.positive {
            color: #4ade80;
        }

        .metric-change.negative {
            color: #dc2626;
        }

        .metric-previous {
            font-size: 12px;
            color: #999999;
        }

        /* Filter Container */
        .filter-container {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-label {
            font-size: 12px;
            color: #ff47cc;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        select {
            padding: 10px 14px;
            background: #ffffff;
            border: 2px solid #f2f2f2;
            color: #222222;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Archivo', Arial, sans-serif;
        }

        select:hover {
            border-color: #ff47cc;
        }

        select:focus {
            outline: none;
            border-color: #ff47cc;
            box-shadow: 0 0 0 3px rgba(255, 71, 204, 0.1);
        }

        /* Breakdown Section */
        .breakdown-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .breakdown-card {
            background: #f2f2f2;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            transition: all 0.3s;
        }

        .breakdown-card:hover {
            background: #ffffff;
            border: 2px solid #ff47cc;
        }

        .breakdown-card-title {
            font-size: 11px;
            color: #ff47cc;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .breakdown-card-value {
            font-size: 16px;
            font-weight: bold;
            color: #222222;
            margin-bottom: 4px;
        }

        .breakdown-card-subtitle {
            font-size: 11px;
            color: #999999;
        }

        /* Section Headers */
        .section-header {
            font-family: 'Archivo Narrow', sans-serif;
            font-size: 18px;
            font-weight: 700;
            color: #222222;
            margin: 30px 0 20px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Charts Grid */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: #ffffff;
            border: 2px solid #f2f2f2;
            border-radius: 16px;
            padding: 25px;
            transition: all 0.3s;
        }

        .chart-container:hover {
            border-color: #ff47cc;
            box-shadow: 0 4px 12px rgba(255, 71, 204, 0.1);
        }

        .chart-title {
            font-family: 'Archivo Narrow', sans-serif;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #222222;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chart-title .chart-icon {
            font-size: 20px;
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
        }

        .chart-wrapper-full {
            position: relative;
            height: 350px;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        /* Table */
        .table-container {
            background: #ffffff;
            border: 2px solid #f2f2f2;
            border-radius: 16px;
            padding: 25px;
            overflow-x: auto;
            margin-bottom: 30px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #f2f2f2;
            color: #ff47cc;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #e5e7eb;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 0.5px;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #f2f2f2;
            color: #222222;
        }

        tr:hover {
            background: #f9f9f9;
        }

        /* Loading & Error */
        .loading {
            text-align: center;
            padding: 40px;
            color: #999999;
        }

        .spinner {
            border: 3px solid #f2f2f2;
            border-top: 3px solid #ff47cc;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: rgba(220, 38, 38, 0.1);
            border: 2px solid #dc2626;
            color: #dc2626;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .header {
                flex-direction: column;
                text-align: center;
            }

            .header-logo img {
                height: 40px;
            }

            .header-title {
                margin-left: 0;
                margin-top: 15px;
            }

            .header-title h1 {
                font-size: 24px;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .metrics-row {
                grid-template-columns: 1fr;
            }

            .metric-card {
                flex-direction: column;
                text-align: center;
            }

            .metric-circle {
                width: 80px;
                height: 80px;
                font-size: 22px;
                margin: 0 auto;
            }

            .metric-info {
                text-align: center;
            }

            .filter-container {
                flex-direction: column;
                align-items: stretch;
            }

            select {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="login-container">
            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 120'%3E%3Ctext x='50%' y='50%' font-size='80' font-weight='bold' fill='%23222' text-anchor='middle' dominant-baseline='middle'%3Eglowee%3C/text%3E%3C/svg%3E" alt="Glowee" class="login-logo">
            <div class="login-title">Glowee Dashboard</div>
            <div class="login-subtitle">P≈ô√≠stup jen pro autorizovan√© u≈æivatele</div>
            <input type="password" id="passwordInput" class="login-input" placeholder="Heslo" onkeypress="if(event.key==='Enter') handleLogin()">
            <button class="login-button" onclick="handleLogin()">P≈ôihl√°sit se</button>
            <div id="loginError" class="login-error"></div>
        </div>
    </div>

    <div class="container" id="dashboardContent" style="display: none;">
        <!-- Header with Logo -->
        <div class="header">
            <div class="header-logo">
                <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 120'%3E%3Ctext x='50%' y='50%' font-size='60' font-weight='bold' fill='%23222' text-anchor='middle' dominant-baseline='middle'%3Eglowee%3C/text%3E%3C/svg%3E" alt="Glowee">
            </div>
            <div class="header-title">
                <h1>Financial Dashboard</h1>
                <p class="header-date" id="headerDate"></p>
            </div>
        </div>

        <!-- Error Container -->
        <div id="error-container"></div>

        <!-- Loading State -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Naƒç√≠t√°m data...</p>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboard-content" style="display: none;">
            <!-- Top Metrics -->
            <div class="metrics-row">
                <div class="metric-card">
                    <div class="metric-circle blue" id="arrivals">73</div>
                    <div class="metric-info">
                        <div class="metric-label">P≈ô√≠jmy tento mƒõs√≠c</div>
                        <div class="metric-change positive" id="revenueChange">-</div>
                        <div class="metric-previous" id="revenuePrevious">-</div>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-circle orange" id="departures">35</div>
                    <div class="metric-info">
                        <div class="metric-label">N√°klady tento mƒõs√≠c</div>
                        <div class="metric-change" id="costsChange">-</div>
                        <div class="metric-previous" id="costsPrevious">-</div>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-circle green" id="bookings">237</div>
                    <div class="metric-info">
                        <div class="metric-label">Zisk tento mƒõs√≠c</div>
                        <div class="metric-change" id="profitChange">-</div>
                        <div class="metric-previous">-</div>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-circle pink" id="margin">-</div>
                    <div class="metric-info">
                        <div class="metric-label">Pr≈Ømƒõrn√° mar≈æe</div>
                        <div class="metric-previous">za sledovan√© obdob√≠</div>
                    </div>
                </div>
            </div>

            <!-- Month Filter -->
            <div class="filter-container">
                <label class="filter-label">üìÖ Filtrovat podle mƒõs√≠ce:</label>
                <select id="monthFilter" onchange="handleMonthFilter()">
                    <option value="">V≈°echny mƒõs√≠ce (Celkov√Ω p≈ôehled)</option>
                </select>
            </div>

            <!-- Breakdown Section for Selected Month -->
            <div id="breakdownSection" style="display: none;">
                <h2 class="section-header">üìä Rozlo≈æen√≠ p≈ô√≠jm≈Ø</h2>
                <div class="breakdown-grid">
                    <div class="breakdown-card">
                        <div class="breakdown-card-title">Tr≈æby VO</div>
                        <div class="breakdown-card-value" id="breakdown-revenueVO">-</div>
                        <div class="breakdown-card-subtitle">P≈ô√≠m√© prodeje</div>
                    </div>
                    <div class="breakdown-card">
                        <div class="breakdown-card-title">Tr≈æby MO</div>
                        <div class="breakdown-card-value" id="breakdown-revenueMO">-</div>
                        <div class="breakdown-card-subtitle">P≈ôes partnery</div>
                    </div>
                </div>

                <h2 class="section-header">üí∞ Rozlo≈æen√≠ n√°klad≈Ø</h2>
                <div class="breakdown-grid">
                    <div class="breakdown-card">
                        <div class="breakdown-card-title">N√°klady COGS VO</div>
                        <div class="breakdown-card-value" id="breakdown-costsVO">-</div>
                        <div class="breakdown-card-subtitle">P≈ô√≠m√Ωch prodej≈Ø</div>
                    </div>
                    <div class="breakdown-card">
                        <div class="breakdown-card-title">N√°klady COGS MO</div>
                        <div class="breakdown-card-value" id="breakdown-costsMO">-</div>
                        <div class="breakdown-card-subtitle">Partnersk√Ωch prodej≈Ø</div>
                    </div>
                    <div class="breakdown-card">
                        <div class="breakdown-card-title">Logistika</div>
                        <div class="breakdown-card-value" id="breakdown-logistika">-</div>
                    </div>
                    <div class="breakdown-card">
                        <div class="breakdown-card-title">Perf. Marketing</div>
                        <div class="breakdown-card-value" id="breakdown-perfMarketing">-</div>
                    </div>
                    <div class="breakdown-card">
                        <div class="breakdown-card-title">Marketing Mzdy</div>
                        <div class="breakdown-card-value" id="breakdown-mktgMzdy">-</div>
                    </div>
                    <div class="breakdown-card">
                        <div class="breakdown-card-title">Ostatn√≠ Marketing</div>
                        <div class="breakdown-card-value" id="breakdown-ostatniMarketing">-</div>
                    </div>
                    <div class="breakdown-card">
                        <div class="breakdown-card-title">Mzda ≈†imon</div>
                        <div class="breakdown-card-value" id="breakdown-mzdaSimon">-</div>
                    </div>
                    <div class="breakdown-card">
                        <div class="breakdown-card-title">Software</div>
                        <div class="breakdown-card-value" id="breakdown-software">-</div>
                    </div>
                    <div class="breakdown-card">
                        <div class="breakdown-card-title">Web Development</div>
                        <div class="breakdown-card-value" id="breakdown-webDevelopment">-</div>
                    </div>
                    <div class="breakdown-card">
                        <div class="breakdown-card-title">√öƒçetnictv√≠</div>
                        <div class="breakdown-card-value" id="breakdown-ucetnictvi">-</div>
                    </div>
                    <div class="breakdown-card">
                        <div class="breakdown-card-title">Jin√© N√°klady</div>
                        <div class="breakdown-card-value" id="breakdown-jineNaklady">-</div>
                    </div>
                </div>

                <div style="margin-top: 30px;">
                    <div class="chart-container full-width">
                        <div class="chart-title">
                            <span>üìä Rozlo≈æen√≠ n√°klad≈Ø</span>
                        </div>
                        <div class="chart-wrapper-full">
                            <canvas id="costBreakdownChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <h2 class="section-header">üìà Grafy a Anal√Ωza</h2>
            <div class="charts-grid">
                <!-- Revenue Chart -->
                <div class="chart-container">
                    <div class="chart-title">
                        <span>üìà V√Ωvoj tr≈æeb</span>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>

                <!-- Costs Chart -->
                <div class="chart-container">
                    <div class="chart-title">
                        <span>üí∞ V√Ωvoj n√°klad≈Ø</span>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="costsChart"></canvas>
                    </div>
                </div>

                <!-- Profit Chart -->
                <div class="chart-container">
                    <div class="chart-title">
                        <span>üíπ V√Ωvoj zisku</span>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="profitChart"></canvas>
                    </div>
                </div>

                <!-- Margin Chart -->
                <div class="chart-container">
                    <div class="chart-title">
                        <span>üìä Hrub√° mar≈æe</span>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="marginChart"></canvas>
                    </div>
                </div>

                <!-- Combined Chart -->
                <div class="chart-container full-width">
                    <div class="chart-title">
                        <span>üìâ Porovn√°n√≠ tr≈æeb, n√°klad≈Ø a zisku</span>
                    </div>
                    <div class="chart-wrapper-full">
                        <canvas id="combinedChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Forecast Section -->
            <h2 class="section-header">üîÆ Forecast - Prodejn√≠ Progn√≥za</h2>
            <div class="charts-grid">
                <div class="chart-container">
                    <div class="chart-title">
                        <span>üì¶ Doporuƒçen√© objedn√°vky</span>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="forecastChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">
                        <span>üìä Predikce vs Skuteƒçnost</span>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="forecastActualChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Forecast Table -->
            <div class="table-container">
                <h2 class="section-header">üìã Tabulka Forecastu</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Produkt</th>
                            <th>Posledn√≠ prodej</th>
                            <th>6M Pr≈Ømƒõr</th>
                            <th>3M Pr≈Ømƒõr</th>
                            <th>Stock</th>
                            <th>Buffer</th>
                            <th>Vypoƒçten√° objedn√°vka</th>
                            <th>Re√°ln√° objedn√°vka</th>
                        </tr>
                    </thead>
                    <tbody id="forecastTableBody">
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 20px;">Naƒç√≠t√°m data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Monthly Table -->
            <h2 class="section-header">üìä Mƒõs√≠ƒçn√≠ Srovn√°n√≠</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Mƒõs√≠c</th>
                            <th>Tr≈æby VO</th>
                            <th>Tr≈æby MO</th>
                            <th>Celk. tr≈æby</th>
                            <th>N√°klady</th>
                            <th>Zisk</th>
                            <th>Mar≈æe %</th>
                        </tr>
                    </thead>
                    <tbody id="monthlyTable">
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 20px;">Naƒç√≠t√°m data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const CSV_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? '/api/sheets-data'
            : `https://docs.google.com/spreadsheets/d/1DWC_T3KfRb1HPZCMeQRtzz-iKh9mo-90ZYR9Ji51pRs/export?format=csv`;

        const FORECAST_CSV_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? '/api/sheets-data?gid=609491221'
            : `https://docs.google.com/spreadsheets/d/1DWC_T3KfRb1HPZCMeQRtzz-iKh9mo-90ZYR9Ji51pRs/export?format=csv&gid=609491221`;

        let chartInstances = {};
        let allData = null;
        let forecastData = null;
        let filteredMonthIndex = null;

        // Login Handler
        function handleLogin() {
            const password = document.getElementById('passwordInput').value;
            if (password === '6969') {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('dashboardContent').style.display = 'block';
                initDashboard();
            } else {
                const errorEl = document.getElementById('loginError');
                errorEl.textContent = 'Nespr√°vn√© heslo!';
                errorEl.style.display = 'block';
                document.getElementById('passwordInput').value = '';
                setTimeout(() => errorEl.style.display = 'none', 3000);
            }
        }

        // Update header date
        function updateHeaderDate() {
            const options = { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' };
            const date = new Date().toLocaleDateString('cs-CZ', options);
            document.getElementById('headerDate').textContent = date.charAt(0).toUpperCase() + date.slice(1);
        }

        // Utility functions
        function parseValue(str) {
            if (!str) return 0;
            const cleaned = str.replace(/[^\d,.-]/g, '').replace(/\s/g, '').replace(',', '.');
            return parseFloat(cleaned) || 0;
        }

        function parsePercentage(str) {
            if (!str) return 0;
            const cleaned = str.replace(/[^\d,]/g, '').replace(',', '.');
            return parseFloat(cleaned) || 0;
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('cs-CZ', {
                style: 'currency',
                currency: 'CZK',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value);
        }

        // Parse Financial Data
        function parseCSV(csv) {
            const lines = csv.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim());

            const months = [];
            const monthIndices = [];

            headers.forEach((header, index) => {
                if (/^\d{2}\/\d{4}$/.test(header)) {
                    months.push(header);
                    monthIndices.push(index);
                }
            });

            const data = {
                months: months,
                revenueVO: [],
                revenueMO: [],
                costsVO: [],
                costsMO: [],
                marginVO: [],
                marginMO: [],
                grossMargin: [],
                logistika: [],
                perfMarketing: [],
                mktgMzdy: [],
                ostatniMarketing: [],
                mzdaSimon: [],
                software: [],
                webDevelopment: [],
                ucetnictvi: [],
                jineNaklady: [],
                profit: [],
                totalRevenue: [],
                totalCosts: [],
                margePercentage: []
            };

            lines.forEach((line, lineIndex) => {
                if (lineIndex === 0) return;

                const values = line.split(',');
                const label = values[0].trim();

                if (!label) return;

                monthIndices.forEach((colIndex, monthIndex) => {
                    const rawValue = values[colIndex] ? values[colIndex].trim() : '';

                    if (label === 'Tr≈æby VO') {
                        data.revenueVO[monthIndex] = parseValue(rawValue);
                    } else if (label === 'Tr≈æby MO') {
                        data.revenueMO[monthIndex] = parseValue(rawValue);
                    } else if (label === 'N√°klady na prodan√© zbo≈æ√≠ VO') {
                        data.costsVO[monthIndex] = parseValue(rawValue);
                    } else if (label === 'N√°klady na prodan√© zbo≈æ√≠ MO') {
                        data.costsMO[monthIndex] = parseValue(rawValue);
                    } else if (label === 'Hrub√° mar≈æe I') {
                        data.grossMargin[monthIndex] = parseValue(rawValue);
                    } else if (label === 'Logistika') {
                        data.logistika[monthIndex] = parseValue(rawValue);
                    } else if (label === 'Perf. marketing') {
                        data.perfMarketing[monthIndex] = parseValue(rawValue);
                    } else if (label === 'Mktg mzdy') {
                        data.mktgMzdy[monthIndex] = parseValue(rawValue);
                    } else if (label === 'Ostatn√≠ marketing') {
                        data.ostatniMarketing[monthIndex] = parseValue(rawValue);
                    } else if (label === 'Mzda ≈†imon') {
                        data.mzdaSimon[monthIndex] = parseValue(rawValue);
                    } else if (label === 'Software') {
                        data.software[monthIndex] = parseValue(rawValue);
                    } else if (label === 'Web Development') {
                        data.webDevelopment[monthIndex] = parseValue(rawValue);
                    } else if (label === '√öƒçetnictv√≠') {
                        data.ucetnictvi[monthIndex] = parseValue(rawValue);
                    } else if (label === 'Jin√© n√°klady') {
                        data.jineNaklady[monthIndex] = parseValue(rawValue);
                    } else if (label === 'VH') {
                        data.profit[monthIndex] = parseValue(rawValue);
                    } else if (label === '% mar≈æe VO') {
                        data.marginVO[monthIndex] = parsePercentage(rawValue);
                    } else if (label === '% mar≈æe MO') {
                        data.marginMO[monthIndex] = parsePercentage(rawValue);
                    }
                });
            });

            data.months.forEach((month, index) => {
                data.totalRevenue[index] = (data.revenueVO[index] || 0) + (data.revenueMO[index] || 0);
                data.totalCosts[index] =
                    (data.costsVO[index] || 0) +
                    (data.costsMO[index] || 0) +
                    (data.logistika[index] || 0) +
                    (data.perfMarketing[index] || 0) +
                    (data.mktgMzdy[index] || 0) +
                    (data.ostatniMarketing[index] || 0) +
                    (data.mzdaSimon[index] || 0) +
                    (data.software[index] || 0) +
                    (data.webDevelopment[index] || 0) +
                    (data.ucetnictvi[index] || 0) +
                    (data.jineNaklady[index] || 0);
            });

            return data;
        }

        // Parse Forecast Data
        function parseForecastCSV(csv) {
            const lines = csv.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim());

            const monthsIndex = {};
            headers.forEach((header, index) => {
                if (/^\d{4}-\d{2}$/.test(header)) {
                    monthsIndex[header] = index;
                }
            });

            const forecast = {
                products: [],
                sales: {},
                sixMonthAvg: {},
                threeMonthAvg: {},
                stock: {},
                buffer: {},
                calculatedOrder: {},
                realOrder: {}
            };

            lines.slice(1).forEach(line => {
                const values = line.split(',');
                const productName = values[0].trim();
                if (!productName) return;

                forecast.products.push(productName);

                // Get last sales value
                let lastSales = 0;
                Object.keys(monthsIndex).forEach(month => {
                    const val = parseValue(values[monthsIndex[month]]);
                    if (val > 0) lastSales = val;
                });

                forecast.sales[productName] = lastSales;
                forecast.sixMonthAvg[productName] = parseValue(values[headers.indexOf('6M Avg')] || '0');
                forecast.threeMonthAvg[productName] = parseValue(values[headers.indexOf('3M Avg')] || '0');
                forecast.stock[productName] = parseValue(values[headers.indexOf('Z√°soba (mƒõs.)')] || '0');
                forecast.buffer[productName] = parseValue(values[headers.indexOf('Buffer (mƒõs.)')] || '0');
                forecast.calculatedOrder[productName] = parseValue(values[headers.indexOf('Vypoƒçten√° objedn√°vka')] || '0');
                forecast.realOrder[productName] = parseValue(values[headers.indexOf('Re√°ln√° objedn√°vka')] || '0');
            });

            return forecast;
        }

        // Fetch data
        async function fetchAndParseData() {
            try {
                const response = await fetch(CSV_URL);
                if (!response.ok) throw new Error('Chyba p≈ôi naƒç√≠t√°n√≠ dat: ' + response.status);
                const csv = await response.text();
                return parseCSV(csv);
            } catch (error) {
                console.error('‚ùå Chyba:', error);
                document.getElementById('error-container').innerHTML =
                    `<div class="error">Nepoda≈ôilo se naƒç√≠st data. Chyba: ${error.message}</div>`;
                throw error;
            }
        }

        async function fetchAndParseForecast() {
            try {
                const response = await fetch(FORECAST_CSV_URL);
                if (!response.ok) throw new Error('Chyba p≈ôi naƒç√≠t√°n√≠ forecastu: ' + response.status);
                const csv = await response.text();
                return parseForecastCSV(csv);
            } catch (error) {
                console.error('‚ùå Chyba forecastu:', error);
                return null;
            }
        }

        // Update KPIs
        function updateKPIs(data) {
            const totalRev = data.totalRevenue.reduce((a, b) => a + b, 0);
            const totalCost = data.totalCosts.reduce((a, b) => a + b, 0);
            const totalProf = data.profit.reduce((a, b) => a + b, 0);

            const avgMargin = data.months.length > 0
                ? ((totalRev - totalCost) / totalRev * 100).toFixed(1)
                : 0;

            const lastRevenue = data.totalRevenue[data.totalRevenue.length - 1];
            const prevRevenue = data.totalRevenue[data.totalRevenue.length - 2] || lastRevenue;
            const revenueChange = ((lastRevenue - prevRevenue) / prevRevenue * 100).toFixed(1);

            document.getElementById('arrivals').textContent = formatCurrency(totalRev).replace('Kƒç', '').trim().split(' ')[0];
            document.getElementById('departures').textContent = formatCurrency(totalCost).replace('Kƒç', '').trim().split(' ')[0];
            document.getElementById('bookings').textContent = formatCurrency(totalProf).replace('Kƒç', '').trim().split(' ')[0];
            document.getElementById('margin').textContent = avgMargin + '%';

            const changeEl = document.getElementById('revenueChange');
            changeEl.textContent = `${revenueChange > 0 ? '+' : ''}${revenueChange}%`;
            changeEl.className = 'metric-change ' + (revenueChange > 0 ? 'positive' : 'negative');

            document.getElementById('revenuePrevious').textContent = formatCurrency(totalRev);
        }

        // Create Charts
        function createCharts(data) {
            const chartConfig = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: {
                            color: '#222222',
                            font: { size: 12, family: 'Archivo' }
                        }
                    }
                },
                scales: {
                    y: {
                        ticks: { color: '#222222' },
                        grid: { color: '#f2f2f2' }
                    },
                    x: {
                        ticks: { color: '#222222' },
                        grid: { color: '#f2f2f2' }
                    }
                }
            };

            // Revenue Chart
            if (chartInstances.revenue) chartInstances.revenue.destroy();
            chartInstances.revenue = new Chart(document.getElementById('revenueChart'), {
                type: 'line',
                data: {
                    labels: data.months,
                    datasets: [
                        {
                            label: 'Tr≈æby VO',
                            data: data.revenueVO,
                            borderColor: '#4A90E2',
                            backgroundColor: 'rgba(74, 144, 226, 0.1)',
                            tension: 0.3,
                            fill: true
                        },
                        {
                            label: 'Tr≈æby MO',
                            data: data.revenueMO,
                            borderColor: '#F5A623',
                            backgroundColor: 'rgba(245, 166, 35, 0.1)',
                            tension: 0.3,
                            fill: true
                        }
                    ]
                },
                options: chartConfig
            });

            // Costs Chart
            if (chartInstances.costs) chartInstances.costs.destroy();
            chartInstances.costs = new Chart(document.getElementById('costsChart'), {
                type: 'bar',
                data: {
                    labels: data.months,
                    datasets: [
                        {
                            label: 'N√°klady VO',
                            data: data.costsVO,
                            backgroundColor: 'rgba(220, 38, 38, 0.7)',
                            borderColor: '#dc2626',
                            borderRadius: 6
                        },
                        {
                            label: 'N√°klady MO',
                            data: data.costsMO,
                            backgroundColor: 'rgba(239, 68, 68, 0.7)',
                            borderColor: '#ef4444',
                            borderRadius: 6
                        }
                    ]
                },
                options: chartConfig
            });

            // Profit Chart
            if (chartInstances.profit) chartInstances.profit.destroy();
            chartInstances.profit = new Chart(document.getElementById('profitChart'), {
                type: 'line',
                data: {
                    labels: data.months,
                    datasets: [{
                        label: 'Zisk',
                        data: data.profit,
                        borderColor: '#4ade80',
                        backgroundColor: 'rgba(74, 222, 128, 0.1)',
                        tension: 0.3,
                        fill: true,
                        pointBackgroundColor: data.profit.map(v => v >= 0 ? '#4ade80' : '#dc2626'),
                        pointBorderColor: data.profit.map(v => v >= 0 ? '#4ade80' : '#dc2626')
                    }]
                },
                options: chartConfig
            });

            // Margin Chart
            if (chartInstances.margin) chartInstances.margin.destroy();
            chartInstances.margin = new Chart(document.getElementById('marginChart'), {
                type: 'line',
                data: {
                    labels: data.months,
                    datasets: [
                        {
                            label: 'Mar≈æe VO %',
                            data: data.marginVO,
                            borderColor: '#4A90E2',
                            backgroundColor: 'rgba(74, 144, 226, 0.1)',
                            tension: 0.3,
                            fill: true
                        },
                        {
                            label: 'Mar≈æe MO %',
                            data: data.marginMO,
                            borderColor: '#F5A623',
                            backgroundColor: 'rgba(245, 166, 35, 0.1)',
                            tension: 0.3,
                            fill: true
                        }
                    ]
                },
                options: chartConfig
            });

            // Combined Chart
            if (chartInstances.combined) chartInstances.combined.destroy();
            chartInstances.combined = new Chart(document.getElementById('combinedChart'), {
                type: 'line',
                data: {
                    labels: data.months,
                    datasets: [
                        {
                            label: 'Tr≈æby',
                            data: data.totalRevenue,
                            borderColor: '#4A90E2',
                            backgroundColor: 'rgba(74, 144, 226, 0.1)',
                            tension: 0.3,
                            yAxisID: 'y',
                            fill: false,
                            borderWidth: 2
                        },
                        {
                            label: 'N√°klady',
                            data: data.totalCosts,
                            borderColor: '#F5A623',
                            backgroundColor: 'rgba(245, 166, 35, 0.1)',
                            tension: 0.3,
                            yAxisID: 'y',
                            fill: false,
                            borderWidth: 2
                        },
                        {
                            label: 'Zisk',
                            data: data.profit,
                            borderColor: '#4ade80',
                            backgroundColor: 'rgba(74, 222, 128, 0.1)',
                            tension: 0.3,
                            yAxisID: 'y',
                            fill: false,
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    ...chartConfig,
                    scales: {
                        ...chartConfig.scales,
                        y: {
                            ...chartConfig.scales.y,
                            position: 'left'
                        }
                    }
                }
            });
        }

        // Cost Breakdown Chart
        function createCostBreakdownChart(data, monthIndex) {
            const costs = [
                { label: 'N√°klady COGS VO', value: data.costsVO[monthIndex] || 0 },
                { label: 'N√°klady COGS MO', value: data.costsMO[monthIndex] || 0 },
                { label: 'Logistika', value: data.logistika[monthIndex] || 0 },
                { label: 'Perf. Marketing', value: data.perfMarketing[monthIndex] || 0 },
                { label: 'Marketing Mzdy', value: data.mktgMzdy[monthIndex] || 0 },
                { label: 'Ostatn√≠ Marketing', value: data.ostatniMarketing[monthIndex] || 0 },
                { label: 'Mzda ≈†imon', value: data.mzdaSimon[monthIndex] || 0 },
                { label: 'Software', value: data.software[monthIndex] || 0 },
                { label: 'Web Development', value: data.webDevelopment[monthIndex] || 0 },
                { label: '√öƒçetnictv√≠', value: data.ucetnictvi[monthIndex] || 0 },
                { label: 'Jin√© N√°klady', value: data.jineNaklady[monthIndex] || 0 }
            ];

            const costColors = ['#dc2626', '#ef4444', '#f87171', '#fca5a5', '#fecaca', '#fed7d7', '#fee2e2', '#fef2f2', '#f5f5f5', '#e5e7eb', '#d1d5db'];
            const costLabels = [];
            const costValues = [];

            costs.forEach((cost, index) => {
                if (cost.value > 0) {
                    costLabels.push(cost.label);
                    costValues.push(cost.value);
                }
            });

            const ctx = document.getElementById('costBreakdownChart');
            if (!ctx) return;

            if (chartInstances.costBreakdown) chartInstances.costBreakdown.destroy();

            chartInstances.costBreakdown = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: costLabels,
                    datasets: [{
                        data: costValues,
                        backgroundColor: costColors.slice(0, costLabels.length),
                        borderColor: '#ffffff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: '#222222',
                                font: { size: 11, family: 'Archivo' },
                                padding: 15,
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    return data.labels.map((label, i) => ({
                                        text: label + ': ' + formatCurrency(data.datasets[0].data[i]),
                                        fillStyle: data.datasets[0].backgroundColor[i],
                                        hidden: false,
                                        index: i
                                    }));
                                }
                            }
                        }
                    }
                }
            });
        }

        // Forecast Charts
        function createForecastCharts(data, forecastData) {
            if (!forecastData || !forecastData.products) return;

            const chartConfig = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: {
                            color: '#222222',
                            font: { size: 12, family: 'Archivo' }
                        }
                    }
                },
                scales: {
                    y: {
                        ticks: { color: '#222222' },
                        grid: { color: '#f2f2f2' }
                    },
                    x: {
                        ticks: { color: '#222222' },
                        grid: { color: '#f2f2f2' }
                    }
                }
            };

            // Forecast Orders Chart
            if (chartInstances.forecast) chartInstances.forecast.destroy();

            const topProducts = forecastData.products.slice(0, 8);
            const realOrders = topProducts.map(p => forecastData.realOrder[p] || 0);
            const calculatedOrders = topProducts.map(p => forecastData.calculatedOrder[p] || 0);

            chartInstances.forecast = new Chart(document.getElementById('forecastChart'), {
                type: 'bar',
                data: {
                    labels: topProducts,
                    datasets: [
                        {
                            label: 'Vypoƒçten√° objedn√°vka',
                            data: calculatedOrders,
                            backgroundColor: 'rgba(74, 144, 226, 0.7)',
                            borderColor: '#4A90E2',
                            borderRadius: 6
                        },
                        {
                            label: 'Re√°ln√° objedn√°vka',
                            data: realOrders,
                            backgroundColor: 'rgba(74, 222, 128, 0.7)',
                            borderColor: '#4ade80',
                            borderRadius: 6
                        }
                    ]
                },
                options: chartConfig
            });

            // Forecast vs Actual (if we have historical data)
            if (chartInstances.forecastActual) chartInstances.forecastActual.destroy();

            chartInstances.forecastActual = new Chart(document.getElementById('forecastActualChart'), {
                type: 'line',
                data: {
                    labels: data.months.slice(-12),
                    datasets: [
                        {
                            label: 'Historick√© tr≈æby',
                            data: data.totalRevenue.slice(-12),
                            borderColor: '#4A90E2',
                            backgroundColor: 'rgba(74, 144, 226, 0.1)',
                            tension: 0.3,
                            fill: true
                        },
                        {
                            label: 'Progn√≥za (dle forecastu)',
                            data: data.totalRevenue.slice(-12).map((v, i) => v * 1.1),
                            borderColor: '#F5A623',
                            backgroundColor: 'rgba(245, 166, 35, 0.1)',
                            borderDash: [5, 5],
                            tension: 0.3,
                            fill: true
                        }
                    ]
                },
                options: chartConfig
            });
        }

        // Populate Month Filter
        function populateMonthFilter(data) {
            const select = document.getElementById('monthFilter');
            data.months.forEach((month, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = month;
                select.appendChild(option);
            });
        }

        // Handle Month Filter
        function handleMonthFilter() {
            const select = document.getElementById('monthFilter');
            const selectedIndex = select.value;

            if (selectedIndex === '') {
                filteredMonthIndex = null;
                document.getElementById('breakdownSection').style.display = 'none';
                updateKPIs(allData);
                createCharts(allData);
                updateMonthlyTable(allData);
            } else {
                filteredMonthIndex = parseInt(selectedIndex);
                document.getElementById('breakdownSection').style.display = 'block';
                updateFilteredView(allData, filteredMonthIndex);
            }
        }

        // Update Filtered View
        function updateFilteredView(data, monthIndex) {
            const month = data.months[monthIndex];
            const revenueVO = data.revenueVO[monthIndex] || 0;
            const revenueMO = data.revenueMO[monthIndex] || 0;
            const costsVO = data.costsVO[monthIndex] || 0;
            const costsMO = data.costsMO[monthIndex] || 0;
            const logistika = data.logistika[monthIndex] || 0;
            const perfMarketing = data.perfMarketing[monthIndex] || 0;
            const mktgMzdy = data.mktgMzdy[monthIndex] || 0;
            const ostatniMarketing = data.ostatniMarketing[monthIndex] || 0;
            const mzdaSimon = data.mzdaSimon[monthIndex] || 0;
            const software = data.software[monthIndex] || 0;
            const webDevelopment = data.webDevelopment[monthIndex] || 0;
            const ucetnictvi = data.ucetnictvi[monthIndex] || 0;
            const jineNaklady = data.jineNaklady[monthIndex] || 0;

            document.getElementById('breakdown-revenueVO').textContent = formatCurrency(revenueVO);
            document.getElementById('breakdown-revenueMO').textContent = formatCurrency(revenueMO);
            document.getElementById('breakdown-costsVO').textContent = formatCurrency(costsVO);
            document.getElementById('breakdown-costsMO').textContent = formatCurrency(costsMO);
            document.getElementById('breakdown-logistika').textContent = formatCurrency(logistika);
            document.getElementById('breakdown-perfMarketing').textContent = formatCurrency(perfMarketing);
            document.getElementById('breakdown-mktgMzdy').textContent = formatCurrency(mktgMzdy);
            document.getElementById('breakdown-ostatniMarketing').textContent = formatCurrency(ostatniMarketing);
            document.getElementById('breakdown-mzdaSimon').textContent = formatCurrency(mzdaSimon);
            document.getElementById('breakdown-software').textContent = formatCurrency(software);
            document.getElementById('breakdown-webDevelopment').textContent = formatCurrency(webDevelopment);
            document.getElementById('breakdown-ucetnictvi').textContent = formatCurrency(ucetnictvi);
            document.getElementById('breakdown-jineNaklady').textContent = formatCurrency(jineNaklady);

            const totalRev = revenueVO + revenueMO;
            const totalCost = costsVO + costsMO + logistika + perfMarketing + mktgMzdy + ostatniMarketing + mzdaSimon + software + webDevelopment + ucetnictvi + jineNaklady;
            const totalProf = totalRev - totalCost;
            const margin = totalRev > 0 ? ((totalProf / totalRev) * 100).toFixed(1) : 0;

            document.getElementById('arrivals').textContent = formatCurrency(totalRev).replace('Kƒç', '').trim().split(' ')[0];
            document.getElementById('departures').textContent = formatCurrency(totalCost).replace('Kƒç', '').trim().split(' ')[0];
            document.getElementById('bookings').textContent = formatCurrency(totalProf).replace('Kƒç', '').trim().split(' ')[0];
            document.getElementById('margin').textContent = margin + '%';

            const filteredData = {
                months: [month],
                revenueVO: [revenueVO],
                revenueMO: [revenueMO],
                costsVO: [costsVO],
                costsMO: [costsMO],
                marginVO: [data.marginVO[monthIndex] || 0],
                marginMO: [data.marginMO[monthIndex] || 0],
                grossMargin: [data.grossMargin[monthIndex] || 0],
                profit: [totalProf],
                totalRevenue: [totalRev],
                totalCosts: [totalCost],
                margePercentage: [margin]
            };

            createCharts(filteredData);
            createCostBreakdownChart(data, monthIndex);
            updateMonthlyTableForMonth(data, monthIndex);
        }

        // Update Monthly Table
        function updateMonthlyTable(data) {
            const tbody = document.getElementById('monthlyTable');
            tbody.innerHTML = '';

            data.months.forEach((month, index) => {
                const row = tbody.insertRow();
                const rev = data.totalRevenue[index] || 0;
                const cost = data.totalCosts[index] || 0;
                const profit = (rev - cost) || 0;
                const margin = rev > 0 ? ((profit / rev) * 100).toFixed(1) : 0;

                row.innerHTML = `
                    <td><strong>${month}</strong></td>
                    <td>${formatCurrency(data.revenueVO[index] || 0)}</td>
                    <td>${formatCurrency(data.revenueMO[index] || 0)}</td>
                    <td><strong>${formatCurrency(rev)}</strong></td>
                    <td>${formatCurrency(cost)}</td>
                    <td><span style="color: ${profit >= 0 ? '#4ade80' : '#dc2626'}">${formatCurrency(profit)}</span></td>
                    <td>${margin}%</td>
                `;
            });
        }

        // Update Monthly Table for Single Month
        function updateMonthlyTableForMonth(data, monthIndex) {
            const tbody = document.getElementById('monthlyTable');
            tbody.innerHTML = '';

            const month = data.months[monthIndex];
            const rev = data.totalRevenue[monthIndex] || 0;
            const cost = data.totalCosts[monthIndex] || 0;
            const profit = (rev - cost) || 0;
            const margin = rev > 0 ? ((profit / rev) * 100).toFixed(1) : 0;

            const row = tbody.insertRow();
            row.innerHTML = `
                <td><strong>${month}</strong></td>
                <td>${formatCurrency(data.revenueVO[monthIndex] || 0)}</td>
                <td>${formatCurrency(data.revenueMO[monthIndex] || 0)}</td>
                <td><strong>${formatCurrency(rev)}</strong></td>
                <td>${formatCurrency(cost)}</td>
                <td><span style="color: ${profit >= 0 ? '#4ade80' : '#dc2626'}">${formatCurrency(profit)}</span></td>
                <td>${margin}%</td>
            `;
        }

        // Update Forecast Table
        function updateForecastTable(forecastData) {
            if (!forecastData || !forecastData.products) return;

            const tbody = document.getElementById('forecastTableBody');
            tbody.innerHTML = '';

            forecastData.products.slice(0, 15).forEach(product => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><strong>${product}</strong></td>
                    <td>${forecastData.sales[product] ? forecastData.sales[product].toFixed(0) : '-'}</td>
                    <td>${forecastData.sixMonthAvg[product] ? forecastData.sixMonthAvg[product].toFixed(0) : '-'}</td>
                    <td>${forecastData.threeMonthAvg[product] ? forecastData.threeMonthAvg[product].toFixed(0) : '-'}</td>
                    <td>${forecastData.stock[product] ? forecastData.stock[product].toFixed(1) : '-'}</td>
                    <td>${forecastData.buffer[product] ? forecastData.buffer[product].toFixed(0) : '-'}</td>
                    <td><strong>${forecastData.calculatedOrder[product] ? forecastData.calculatedOrder[product].toFixed(0) : '-'}</strong></td>
                    <td><span style="color: #4ade80"><strong>${forecastData.realOrder[product] ? forecastData.realOrder[product].toFixed(0) : '-'}</strong></span></td>
                `;
            });
        }

        // Initialize Dashboard
        async function initDashboard() {
            try {
                updateHeaderDate();

                const [data, forecast] = await Promise.all([
                    fetchAndParseData(),
                    fetchAndParseForecast()
                ]);

                allData = data;
                forecastData = forecast;

                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard-content').style.display = 'block';

                populateMonthFilter(data);
                updateKPIs(data);
                createCharts(data);
                updateMonthlyTable(data);

                if (forecastData) {
                    createForecastCharts(data, forecastData);
                    updateForecastTable(forecastData);
                }
            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                console.error('Chyba p≈ôi inicializaci:', error);
            }
        }

        // Initialize on load
        updateHeaderDate();
    </script>
</body>
</html>
